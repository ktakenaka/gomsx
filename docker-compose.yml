version: "3"

x-var: &ENV
  "development"
x-var: &DB_USER
  "gomsx"
x-var: &DB_PASSWORD
  "gomsx"
x-var: &DB_HOST
  "database"
x-var: &DB_NAME
  "gomsx"

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile-dev
    tty: true
    ports:
      - 8080:8080
    volumes:
      - .:/go/src:cached
    environment:
      ENV: *ENV
      DB_USER: *DB_USER
      DB_PASSWORD: *DB_PASSWORD
      DB_HOST: *DB_HOST
    logging:
      driver: "json-file"
      options:
        max-file: "3"
        max-size: "5m"
    tty: true

  database:
    platform: linux/x86_64
    build:
      context: ./docker/mysql
      dockerfile: Dockerfile
    ports:
      - 3306:3306
    volumes:
      - ./db-data:/var/lib/mysql:delegated
      - ./docker/db/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf"
    environment:
      MYSQL_ROOT_PASSWORD: root
      BIND-ADDRESS: 0.0.0.0

  sqlboiler:
    build:
      context: ./tools/sqlboiler
      dockerfile: Dockerfile
    volumes:
      - ./tools/sqlboiler/sqlboiler.toml:/sqlboiler.toml
      - ./app/internal/models/v1.0:/sqlboiler

  migration:
    build:
      context: ./tools/sqlmigrate
      dockerfile: Dockerfile
    volumes:
      - ./tools/sqlmigrate/dbconfig.yml:/db/dbconfig.yml
      - ./db/migrations:/db/migrations
    environment:
      DB_USER: *DB_USER
      DB_PASSWORD: *DB_PASSWORD
      DB_HOST: *DB_HOST
      DB_NAME: *DB_NAME
      DB_PORT: 3306
